"use strict";!function(){function e(e,t,n){return e.addEventListener(t,n)}function t(e){return document.getElementById(e)}function n(e){return t(e).value}function a(){var e=Math.floor(8*Math.random());return e>0&&e<=3?" bg"+e:""}function i(e){var t="square";return e&STATE_PLAYER&&(t+=" player"),e&STATE_WALL&&(t+=" wall"),e&STATE_DYNAMITE&&(t+=" dynamite"),e&STATE_MONEY&&(t+=" money"),e&STATE_RHUM&&(t+=" rhum"),e&STATE_BOUM&&(t+=" boum"),t}function s(e){return e&STATE_DYNAMITE?"Dynamite":e&STATE_WALL?"Wall":void 0}function o(e){var t=.8*window.innerWidth*.48,n=.9*window.innerHeight*.85,a=Math.min(Math.floor(t/e.columns),Math.floor(n/e.rows));return{width:a+"px",height:a+"px"}}function d(e){for(;e.children.length;)e.removeChild(e.children[e.children.length-1])}function r(e,t){t="boolean"==typeof t?t:e.className.includes("off"),L[e.id]=t,t?e.classList.remove("off"):e.classList.add("off")}function u(e){d(U),e.forEach(function(e){var t=document.createElement("option");t.setAttribute("value",e.id),t.innerHTML=e.name+" - player(s) : "+e.dungeons.length,U.appendChild(t)})}function l(){Array.apply(null,S.getElementsByTagName("button")).forEach(function(e){var t=e.getAttribute("data-option-index");parseInt(t,10)==A.selectedOption?e.classList.add("selected"):e.classList.remove("selected")})}function c(e){var t=e.target.getAttribute("data-option-index");A.selectedOption=parseInt(t),l()}function E(){var e=find(A.game.dungeons,T.id).config,t=A.game.options;if(t.length<=0)throw new Error("Invalid option list for controll.");d(S),-1==t.indexOf(A.selectedOption)&&(A.selectedOption=t[0]),t.forEach(function(t){var n=h("li"),a=h("button",{"data-option-index":t},{click:c}),i=s(t);a.innerHTML=i+" "+e[i.toLowerCase()+"Cost"]+'<div class="icon money"></div>',n.appendChild(a),S.appendChild(n)}),l()}function p(e,t){for(var n in t)e.style[n]=t[n]}function f(e,t){for(var n in t)e.setAttribute(n,t[n])}function h(e,t,n){var a=document.createElement(e);t=t||{},n=n||{},f(a,t);for(var i in n)a.addEventListener(i,n[i]);return a}function v(e){A=new g(T),A.updateGame(e)}function g(e){this.id=e.id,this.game,this.dungeonsUI=[],this.selectedOption=STATE_WALL,this.selectedAdversary,this.keypressed=!1;var t=this;window.addEventListener("wheel",function(e){t.navigateThroughAdversaries(e)})}function m(){T.on(GAME_EVENT_LISTED,function(e){u(e)}),T.on(GAME_EVENT_CREATED,function(e){v(e),E()}),T.on(GAME_EVENT_STARTED,function(){r(D)}),T.on(GAME_EVENT_EDITED,function(e){A?A.updateGame(e):v(e),E()}),T.on(GAME_EVENT_FINISHED,function(e){A.updateGame(e)}),T.on("disconnect",function(){window.location.reload(!0)}),P.forEach(function(t){e(t,"click",function(){switch(t.id){case GAME_EVENT_CREATE:T.emit(t.id,{areaColumns:n("ac"),areaRows:n("ar"),name:n("gn")});break;case GAME_EVENT_JOIN:T.emit(t.id,{gameId:n("gl")});break;case GAME_EVENT_START:T.emit(t.id,{name:n("dn")});break;case GAME_EVENT_LIST:T.emit(t.id,{playerId:T.id});break;default:throw new Error("Un-managed button : "+t.id)}})}),window.addEventListener("resize",function(){A&&A.updateUI()}),window.addEventListener("mousemove",function(e){G=e.clientX,b=e.clientY}),window.addEventListener("contextmenu",function(e){e.preventDefault(),e.stopPropagation(),r(D),L[D.id]&&(D.style.left=G+"px",D.style.top=b+"px")}),window.addEventListener("keydown",function(e){var t,n=e.keyCode;A&&(A.keypressed||(A.keypressed=!0,87===n||38===n?t=MOVE_UP:40===n||83===n?t=MOVE_DOWN:65===n||37===n?t=MOVE_LEFT:68!==n&&39!==n||(t=MOVE_RIGHT),t&&T.emit(PLAY_EVENT_MOVE,t),C=window.setTimeout(function(){A.keypressed=!1},100)))}),window.addEventListener("keyup",function(){clearInterval(C),A&&(A.keypressed=!1)})}function w(e,t){this.id=t.id,this.randomBGMap=[],this.style,this.area=[],this.dungeonElt,this.nameElt,this.lifeCountElt,this.moneyCountElt,this.dungeonPreviewElt,this.previewDungeonName,this.previewLifeCountElt,this.previewMoneyCountElt,this.statusElt,this.statusNameElt,this.statusLifeCountElt,this.statusMoneyCountElt,this.init(t)}function y(){T=io({upgrade:!1,transports:["websocket"]}),m(),T.emit(GAME_EVENT_LIST,{playerId:T.id})}g.prototype={updateGame:function(e){this.game=e,this.updateUI()},selectAdversary:function(e){var t=this;e=e||t.selectedAdversary;for(var n=0;!e&&n<t.dungeonsUI.length;){var a=t.dungeonsUI[n].id;a!=t.id&&(e=a),n++}if(t.id==e)throw new Error("Invalid id selected for adversary.");var i=find(t.dungeonsUI,t.selectedAdversary);i&&(i.dungeonElt.classList.remove("selected"),i.dungeonPreviewElt.classList.remove("selected")),t.selectedAdversary=e,(i=find(t.dungeonsUI,e))&&(i.dungeonElt.classList.add("selected"),i.dungeonPreviewElt.classList.add("selected"))},navigateThroughAdversaries:function(e){var t=this.dungeonsUI.length;if(!(t<2)){var n=findIndex(this.dungeonsUI,this.selectedAdversary),a=findIndex(this.dungeonsUI,this.id);do{e.deltaY<0?n++:n--,n=n>t-1?0:n,n=n<0?t-1:n}while(n==a);this.selectAdversary(this.dungeonsUI[n].id)}},deleteDungeonUI:function(e){[e.dungeonElt,e.dungeonPreviewElt,e.statusElt].forEach(function(e){e.parentElement.removeChild(e)});var t=this.dungeonsUI.indexOf(e);this.dungeonsUI.splice(t,1),this.selectedAdversary==e.id&&(this.selectedAdversary=void 0),this.selectAdversary()},applyOptionEvent:function(e){var t=e.target,n=t.getAttribute("data-dungeon-id"),a=parseInt(t.getAttribute("data-area-x"),10),i=parseInt(t.getAttribute("data-area-y"),10);T.emit(PLAY_EVENT_APPLY,{opponentId:n,state:A.selectedOption,x:a,y:i})},addDungeonUI:function(n){var a=this,i=new w(a,n);a.dungeonsUI.push(i),t("m-status").appendChild(i.statusElt),n.id==a.id?t("m-panel").appendChild(i.dungeonElt):(t("a-panels").appendChild(i.dungeonElt),t("a-previews").appendChild(i.dungeonPreviewElt),e(i.dungeonPreviewElt,"click",function(e){e.preventDefault(),e.stopPropagation(),a.selectAdversary(i.id)}),a.selectAdversary())},updateUI:function(){var e=this;e.dungeonsUI.forEach(function(t){find(e.game.dungeons,t.id)||e.deleteDungeonUI(t)}),e.game.dungeons.forEach(function(t){var n=find(e.dungeonsUI,t.id);n?n.updateFromDungeon(t):e.addDungeonUI(t)}),e.updateUIFromSTatus(),e.selectAdversary(e.selectedAdversary)},updateUIFromSTatus:function(){var e=this,t=e.game.status,n=find(e.game.dungeons,e.id);if(M.className=t,N.className=n.status,_.className=n.status,t==G_STATUS_SETUP)r(I,!1),r(D,!1);else if(e.game.status==G_STATUS_RUNNING)r(I,!1);else{if(e.game.status!=G_STATUS_FINISHED)throw new Error("Unknown game status.");r(I,!1),r(D,!1)}}};var T,A,C,L={},I=t("home-menu"),M=t("main-ctrl"),_=t("m-setup"),N=t("m-panel"),U=(t("a-panels"),t("gl")),D=t("option-list"),S=D.getElementsByTagName("ul")[0],P=Array.apply(null,document.getElementsByTagName("button")),G=0,b=0;w.prototype={updateFromDungeon:function(e){var t=this;t.nameElt.innerHTML=e.name,t.previewDungeonName.innerHTML=e.name,t.statusNameElt.innerHTML=e.name,t.lifeCountElt.innerHTML=e.life,t.previewLifeCountElt.innerHTML=e.life,t.statusLifeCountElt.innerHTML=e.life,t.moneyCountElt.innerHTML=e.money,t.previewMoneyCountElt.innerHTML=e.money,t.statusMoneyCountElt.innerHTML=e.money,t.dungeonElt.className=e.status,t.statusElt.className=e.status,t.dungeonPreviewElt.className=e.status,t.style=o(e.area),e.area.states.forEach(function(e,n){e.forEach(function(e,a){f(t.area[n][a],{class:i(e.state)+t.randomBGMap[n][a]}),p(t.area[n][a],t.style)})})},init:function(e){this.createDungeonElt(e),this.createDungeonPreviewElt(e),this.createStatusElt(e),this.updateFromDungeon(e)},createDungeonElt:function(e){var t=this;t.dungeonElt=h("section",{id:e.id});for(var n=h("h1"),s=h("div",{class:"area"}),o=h("div",{class:"status-container"}),d=h("p",{class:"life-count"}),r=h("p",{class:"money-count"}),u=0;u<3;u++)s.appendChild(h("div",{class:"light"}));for(var l=0;l<e.area.rows;l++){var c=[],E=[],f=h("div",{class:"row"});s.appendChild(f);for(var v=0;v<e.area.columns;v++){var g=a(),m=h("div",{class:"boum"}),w=h("div",{class:i(e.area.states[l][v].state)+g,"data-area-x":v,"data-area-y":l,"data-dungeon-id":e.id},{click:A.applyOptionEvent.bind(t)});w.appendChild(m),p(w,t.style),f.appendChild(w),c.push(w),E.push(g)}t.area.push(c),t.randomBGMap.push(E)}o.appendChild(d),o.appendChild(r),t.dungeonElt.appendChild(n),t.dungeonElt.appendChild(o),t.dungeonElt.appendChild(s),t.nameElt=n,t.lifeCountElt=d,t.moneyCountElt=r},createDungeonPreviewElt:function(e){var t=this;t.dungeonPreviewElt=h("div",{"data-dungeon-id":e.id}),t.previewLifeCountElt=h("p",{class:"life-count"}),t.previewMoneyCountElt=h("p",{class:"money-count"}),t.previewDungeonName=h("h2"),t.dungeonPreviewElt.appendChild(t.previewDungeonName),t.dungeonPreviewElt.appendChild(t.previewLifeCountElt),t.dungeonPreviewElt.appendChild(t.previewMoneyCountElt)},createStatusElt:function(e){var t=this;t.statusElt=h("div",{"data-dungeon-id":e.id}),t.statusNameElt=h("h2"),t.statusLifeCountElt=h("p",{class:"life-count"}),t.statusMoneyCountElt=h("p",{class:"money-count"});var n=h("p",{class:"status"});t.statusElt.appendChild(t.statusNameElt),t.statusElt.appendChild(t.statusLifeCountElt),t.statusElt.appendChild(t.statusMoneyCountElt),t.dungeonPreviewElt.appendChild(n)}},window.addEventListener("load",y,!1)}();