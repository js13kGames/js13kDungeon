"use strict";!function(){function e(e,t,n){return e.addEventListener(t,n)}function t(e){return document.getElementById(e)}function n(e){return t(e).value}function i(){var e=Math.floor(8*Math.random());return e>0&&e<=3?" bg"+e:""}function a(e){var t="square";return e&STATE_PLAYER&&(t+=" player"),e&STATE_WALL&&(t+=" wall"),e&STATE_DYNAMITE&&(t+=" dynamite"),e&STATE_MONEY&&(t+=" money"),e&STATE_RHUM&&(t+=" rhum"),e&STATE_BOUM&&(t+=" boum"),t}function o(e){return e&STATE_DYNAMITE?"Dynamite":e&STATE_WALL?"Wall":void 0}function d(e){var t=.8*window.innerWidth*.48,n=.9*window.innerHeight*.85,i=Math.min(Math.floor(t/e.columns),Math.floor(n/e.rows));return{width:i+"px",height:i+"px"}}function s(e){for(;e.children.length;)e.removeChild(e.children[e.children.length-1])}function r(e,t){t="boolean"==typeof t?t:e.className.includes("off"),_[e.id]=t,t?e.classList.remove("off"):e.classList.add("off")}function l(e){s(U),e.forEach(function(e){var t=document.createElement("option");t.setAttribute("value",e.id),t.innerHTML=e.name+" - player(s) : "+e.dungeons.length,U.appendChild(t)})}function u(){Array.apply(null,D.getElementsByTagName("button")).forEach(function(e){var t=e.getAttribute("data-option-index");parseInt(t,10)==C.selectedOption?e.classList.add("selected"):e.classList.remove("selected")})}function c(e){var t=e.target.getAttribute("data-option-index");C.selectedOption=parseInt(t),u()}function E(){var e=find(C.game.dungeons,A.id).config,t=C.game.options;if(t.length<=0)throw new Error("Invalid option list for controll.");s(D),-1==t.indexOf(C.selectedOption)&&(C.selectedOption=t[0]),t.forEach(function(t){var n=h("li"),i=h("button",{"data-option-index":t},{click:c}),a=o(t);i.innerHTML=a+" "+e[a.toLowerCase()+"Cost"]+'<div class="icon money"></div>',n.appendChild(i),D.appendChild(n)}),u()}function p(e,t){for(var n in t)e.style[n]=t[n]}function f(e,t){for(var n in t)e.setAttribute(n,t[n])}function h(e,t,n){var i=document.createElement(e);t=t||{},n=n||{},f(i,t);for(var a in n)i.addEventListener(a,n[a]);return i}function m(e){C=new v(A),C.updateGame(e)}function v(e){this.id=e.id,this.game,this.dungeonsUI=[],this.selectedOption=STATE_WALL,this.selectedAdversary,this.keypressed=!1;var t=this;window.addEventListener("wheel",function(e){t.navigateThroughAdversaries(e)})}function g(e){C&&C.notify({title:"Welcome in "+e.name,body:"Hit the ready button when you are \n don't forget to name your warrior !",duration:12e3})}function y(){A.on(GAME_EVENT_LISTED,function(e){l(e)}),A.on(GAME_EVENT_CREATED,function(e){m(e),E()}),A.on(GAME_EVENT_STARTED,function(){r(S),C.notify({title:"Game STARTED !",body:"Fight for your life, and remember... watch you steps"},V)}),A.on(GAME_EVENT_JOIN,function(e){e.id===A.id?g(e):C.notify({title:"new Player joined "+e.name,body:"Another mighty heroe to join the battle",duration:V})}),A.on(PLAY_EVENT_LOST,function(e){C.notify({title:e.name+" lost the game !",body:"Alas, another hero falls",duration:V})}),A.on(D_STATUS_WON,function(e){C.notify({title:e.name+" won the game !",body:"All hails the mighty Hero who defeated his foes",duration:1e4})}),A.on(GAME_EVENT_LEAVE,function(e){C.notify({title:e.name+" left the game",body:"The corridors feel a little bit more peacefull",duration:V})}),A.on(GAME_EVENT_EDITED,function(e){C?C.updateGame(e):m(e),E()}),A.on(D_STATUS_READY,function(e){C.notify({title:e.dungeon.name+" ready !",body:e.readyPlayers+"/"+C.game.dungeons.length+" players are ready",duration:V})}),A.on(GAME_EVENT_FINISHED,function(e){C.updateGame(e)}),A.on("disconnect",function(){window.location.reload(!0)}),P.forEach(function(t){e(t,"click",function(){switch(t.id){case GAME_EVENT_CREATE:A.emit(t.id,{areaColumns:n("ac"),areaRows:n("ar"),name:n("gn")});break;case GAME_EVENT_JOIN:A.emit(t.id,{gameId:n("gl")});break;case GAME_EVENT_START:A.emit(t.id,{name:n("dn")});break;case GAME_EVENT_LIST:A.emit(t.id,{playerId:A.id});break;default:throw new Error("Un-managed button : "+t.id)}})}),window.addEventListener("resize",function(){C&&C.updateUI()}),window.addEventListener("mousemove",function(e){G=e.clientX,O=e.clientY}),window.addEventListener("contextmenu",function(e){e.preventDefault(),e.stopPropagation(),r(S),_[S.id]&&(S.style.left=G+"px",S.style.top=O+"px")}),window.addEventListener("keydown",function(e){var t,n=e.keyCode;C&&(C.keypressed||(C.keypressed=!0,87===n||38===n?t=MOVE_UP:40===n||83===n?t=MOVE_DOWN:65===n||37===n?t=MOVE_LEFT:68!==n&&39!==n||(t=MOVE_RIGHT),t&&A.emit(PLAY_EVENT_MOVE,t),L=window.setTimeout(function(){C.keypressed=!1},100)))}),window.addEventListener("keyup",function(){clearInterval(L),C&&(C.keypressed=!1)})}function w(e,t){this.id=t.id,this.randomBGMap=[],this.style,this.area=[],this.dungeonElt,this.nameElt,this.lifeCountElt,this.moneyCountElt,this.dungeonPreviewElt,this.previewDungeonName,this.previewLifeCountElt,this.previewMoneyCountElt,this.statusElt,this.statusNameElt,this.statusLifeCountElt,this.statusMoneyCountElt,this.init(t)}function T(){A=io({upgrade:!1,transports:["websocket"]}),y(),A.emit(GAME_EVENT_LIST,{playerId:A.id})}v.prototype={updateGame:function(e){this.game=e,this.updateUI()},selectAdversary:function(e){var t=this;e=e||t.selectedAdversary;for(var n=0;!e&&n<t.dungeonsUI.length;){var i=t.dungeonsUI[n].id;i!=t.id&&(e=i),n++}if(t.id==e)throw new Error("Invalid id selected for adversary.");var a=find(t.dungeonsUI,t.selectedAdversary);a&&(a.dungeonElt.classList.remove("selected"),a.dungeonPreviewElt.classList.remove("selected")),t.selectedAdversary=e,(a=find(t.dungeonsUI,e))&&(a.dungeonElt.classList.add("selected"),a.dungeonPreviewElt.classList.add("selected"))},navigateThroughAdversaries:function(e){var t=this.dungeonsUI.length;if(!(t<2)){var n=findIndex(this.dungeonsUI,this.selectedAdversary),i=findIndex(this.dungeonsUI,this.id);do{e.deltaY<0?n++:n--,n=n>t-1?0:n,n=n<0?t-1:n}while(n==i);this.selectAdversary(this.dungeonsUI[n].id)}},deleteDungeonUI:function(e){[e.dungeonElt,e.dungeonPreviewElt,e.statusElt].forEach(function(e){e.parentElement.removeChild(e)});var t=this.dungeonsUI.indexOf(e);this.dungeonsUI.splice(t,1),this.selectedAdversary==e.id&&(this.selectedAdversary=void 0),this.selectAdversary()},applyOptionEvent:function(e){var t=e.target,n=t.getAttribute("data-dungeon-id"),i=parseInt(t.getAttribute("data-area-x"),10),a=parseInt(t.getAttribute("data-area-y"),10);A.emit(PLAY_EVENT_APPLY,{opponentId:n,state:C.selectedOption,x:i,y:a})},addDungeonUI:function(n){var i=this,a=new w(i,n);i.dungeonsUI.push(a),t("m-status").appendChild(a.statusElt),n.id==i.id?t("m-panel").appendChild(a.dungeonElt):(t("a-panels").appendChild(a.dungeonElt),t("a-previews").appendChild(a.dungeonPreviewElt),e(a.dungeonPreviewElt,"click",function(e){e.preventDefault(),e.stopPropagation(),i.selectAdversary(a.id)}),i.selectAdversary())},updateUI:function(){var e=this;e.dungeonsUI.forEach(function(t){find(e.game.dungeons,t.id)||e.deleteDungeonUI(t)}),e.game.dungeons.forEach(function(t){var n=find(e.dungeonsUI,t.id);n?n.updateFromDungeon(t):e.addDungeonUI(t)}),e.updateUIFromSTatus(),e.selectAdversary(e.selectedAdversary)},notify:function(e){var t,n=h("div",{id:"modal"}),i=h("h1"),a=h("p");i.innerHTML=e.title,a.innerHTML=e.body,n.appendChild(i),n.appendChild(a),document.body.appendChild(n),window.setTimeout(function(){n.classList.add("modal-in"),t=window.setTimeout(function(){n.classList.add("modal-out"),window.setTimeout(function(){document.body.removeChild(n)},3e3)},e.duration||1500)},100),window.addEventListener("keydown",function(e){27===e.keyCode&&(window.clearTimeout(t),document.body.removeChild(n))})},updateUIFromSTatus:function(){var e=this,t=e.game.status,n=find(e.game.dungeons,e.id);if(M.className=t,b.className=n.status,N.className=n.status,t==G_STATUS_SETUP)r(I,!1),r(S,!1);else if(e.game.status==G_STATUS_RUNNING)r(I,!1);else{if(e.game.status!=G_STATUS_FINISHED)throw new Error("Unknown game status.");r(I,!1),r(S,!1)}}};var A,C,L,_={},I=t("home-menu"),M=t("main-ctrl"),N=t("m-setup"),b=t("m-panel"),U=(t("a-panels"),t("gl")),S=t("option-list"),D=S.getElementsByTagName("ul")[0],P=Array.apply(null,document.getElementsByTagName("button")),G=0,O=0,V=5e3;w.prototype={updateFromDungeon:function(e){var t=this;t.nameElt.innerHTML=e.name,t.previewDungeonName.innerHTML=e.name,t.statusNameElt.innerHTML=e.name,t.lifeCountElt.innerHTML=e.life,t.previewLifeCountElt.innerHTML=e.life,t.statusLifeCountElt.innerHTML=e.life,t.moneyCountElt.innerHTML=e.money,t.previewMoneyCountElt.innerHTML=e.money,t.statusMoneyCountElt.innerHTML=e.money,t.dungeonElt.className=e.status,t.statusElt.className=e.status,t.dungeonPreviewElt.className=e.status,t.style=d(e.area),e.area.states.forEach(function(e,n){e.forEach(function(e,i){f(t.area[n][i],{class:a(e.state)+t.randomBGMap[n][i]}),p(t.area[n][i],t.style)})})},init:function(e){this.createDungeonElt(e),this.createDungeonPreviewElt(e),this.createStatusElt(e),this.updateFromDungeon(e)},createDungeonElt:function(e){var t=this;t.dungeonElt=h("section",{id:e.id});for(var n=h("h1"),o=h("div",{class:"area"}),d=h("div",{class:"status-container"}),s=h("p",{class:"life-count"}),r=h("p",{class:"money-count"}),l=0;l<3;l++)o.appendChild(h("div",{class:"light"}));for(var u=0;u<e.area.rows;u++){var c=[],E=[],f=h("div",{class:"row"});o.appendChild(f);for(var m=0;m<e.area.columns;m++){var v=i(),g=h("div",{class:"boum"}),y=h("div",{class:a(e.area.states[u][m].state)+v,"data-area-x":m,"data-area-y":u,"data-dungeon-id":e.id},{click:C.applyOptionEvent.bind(t)});y.appendChild(g),p(y,t.style),f.appendChild(y),c.push(y),E.push(v)}t.area.push(c),t.randomBGMap.push(E)}d.appendChild(s),d.appendChild(r),t.dungeonElt.appendChild(n),t.dungeonElt.appendChild(d),t.dungeonElt.appendChild(o),t.nameElt=n,t.lifeCountElt=s,t.moneyCountElt=r},createDungeonPreviewElt:function(e){var t=this;t.dungeonPreviewElt=h("div",{"data-dungeon-id":e.id}),t.previewLifeCountElt=h("p",{class:"life-count"}),t.previewMoneyCountElt=h("p",{class:"money-count"}),t.previewDungeonName=h("h2"),t.dungeonPreviewElt.appendChild(t.previewDungeonName),t.dungeonPreviewElt.appendChild(t.previewLifeCountElt),t.dungeonPreviewElt.appendChild(t.previewMoneyCountElt)},createStatusElt:function(e){var t=this;t.statusElt=h("div",{"data-dungeon-id":e.id}),t.statusNameElt=h("h2"),t.statusLifeCountElt=h("p",{class:"life-count"}),t.statusMoneyCountElt=h("p",{class:"money-count"});var n=h("p",{class:"status"});t.statusElt.appendChild(t.statusNameElt),t.statusElt.appendChild(t.statusLifeCountElt),t.statusElt.appendChild(t.statusMoneyCountElt),t.dungeonPreviewElt.appendChild(n)}},window.addEventListener("load",T,!1)}();