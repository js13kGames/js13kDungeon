"use strict";function broadcast(t,s,e){t.socket.broadcast.to(t.socket.id).emit(s,e),t.socket.emit(s,e)}function listRooms(t){return games.filter(function(s){return s.status==t}).map(function(t){return t.toJSON()})}function findGameByDungeonId(t){for(var s=0;s<games.length;s++)for(var e=0;e<games[s].dungeons.length;e++)if(games[s].dungeons[e].id===t)return games[s]}function findGameById(t){return find(games,t)}function ServerController(t){this.socket=t,this.id=t.id,this.init()}function Game(t,s,e,i){this.socket=t,this.id=this.socket.id,this.name=s,this.dungeons=[],this.status=G_STATUS_SETUP,this.time=0,this.options=i||[STATE_WALL,STATE_DYNAMITE],this.configTemplate=e||new Config}function Dungeon(t,s,e){this.id=t,this.status=D_STATUS_SETUP,this.area=new Area,this.life=100,this.money=100,this.lastUpdateTime=0,this.name=e||t,this.player,this.config=new Config(s),this.createArea(this.config.areaColumns,this.config.areaRows),this.modifiers={timeLimitMalus:0}}function Area(t,s){this.reset(t,s)}function Config(t){this.fromJSON(t)}var controllers=[],games=[];ServerController.prototype={init:function(){var t=this;this.socket.on(GAME_EVENT_CREATE,function(s){var e=findGameById(t.id);if(e)console.warn("A game already exists for given id.");else{e=new Game(t.socket,s.name||t.id,new Config(s));var i=new Dungeon(t.id,e.configTemplate);e.addDungeon(i),games.push(e),t.socket.emit(GAME_EVENT_CREATED,e.toJSON())}}),this.socket.on(GAME_EVENT_LIST,function(){t.socket.emit(GAME_EVENT_LISTED,listRooms(G_STATUS_SETUP))}),this.socket.on("disconnect",function(){for(var s=findGameByDungeonId(t.id);s;)s.removeDungeon(t.id),s.dungeons.length<=0&&games.splice(findIndex(games,s.id),1),broadcast(s,GAME_EVENT_EDITED,s.toJSON()),s=findGameByDungeonId(t.id);var e=findIndex(controllers,t.id);e&&controllers.splice(e,1),console.log("Disconnected: "+t.socket.id)}),this.socket.on(GAME_EVENT_JOIN,function(s){var e=findGameById(s.gameId);if(e&&e.status===G_STATUS_SETUP){t.socket.join(s.gameId);var i=new Dungeon(t.id,e.configTemplate,s.dungeonName);e.addDungeon(i)&&(broadcast(e,GAME_EVENT_EDITED,e.toJSON()),console.log(t.id+" has joined: "+e.id))}else console.log("Error : can't connect to game "+s.gameId)}),this.socket.on(PLAY_EVENT_MOVE,function(s){var e=findGameByDungeonId(t.id);if(e&&e.status===G_STATUS_RUNNING){var i=find(e.dungeons,t.id);i&&i.movePlayer(s)&&(i.lastUpdateTime=0,broadcast(e,PLAY_EVENT_UPDATE,e.toJSON()))}}),this.socket.on(PLAY_EVENT_APPLY,function(s){var e=findGameByDungeonId(t.id);if(e&&e.status===G_STATUS_RUNNING){var i=find(e.dungeons,t.id),n=find(e.dungeons,s.opponentId);i&&n&&n.applyState(s.x,s.y,s.state,i)&&(i.deduceMoney(s.state),broadcast(e,PLAY_EVENT_UPDATE,e.toJSON()))}}),this.socket.on(GAME_EVENT_START,function(s){var e=findGameByDungeonId(t.id);if(e&&e.status===G_STATUS_SETUP){var i=find(e.dungeons,t.id);i.status=D_STATUS_READY,i.name=s.name||i.name||t.id;var n=e.startIfReady();broadcast(e,GAME_EVENT_EDITED,e.toJSON()),n<e.dungeons.length&&broadcast(e,D_STATUS_READY,{dungeon:i,readyPlayers:n})}})}},Game.prototype={removeDungeon:function(t){var s=findIndex(this.dungeons,t);s>=0&&(broadcast(this,GAME_EVENT_LEAVE,this.dungeons[s].toJSON()),this.dungeons.splice(s,1))},addDungeon:function(t){var s=this;return find(this.dungeons,t.id)?(console.warn(t.id+" already in game "+this.id),!1):(this.socket.join(t.id),this.dungeons.push(t),setTimeout(function(){broadcast(s,GAME_EVENT_JOIN,t.toJSON())},1e3),!0)},startIfReady:function(){var t=1;if(this.status===G_STATUS_SETUP){for(var s=0;s<this.dungeons.length;s++){if(this.dungeons[s].status!==D_STATUS_READY)return t;t++}this.status=G_STATUS_RUNNING,this.dungeons.map(function(t){t.status=D_STATUS_PLAYING}),this.time=0,this.clock=setInterval(this.checkClock.bind(this),1e3),broadcast(this,GAME_EVENT_STARTED,this.toJSON()),broadcast(this,PLAY_EVENT_UPDATE,this.toJSON())}return t},stop:function(){var t=this;t.status=G_STATUS_FINISHED,clearInterval(t.clock),broadcast(t,GAME_EVENT_FINISHED,t.toJSON()),setTimeout(function(){t.socket.disconnect(!1)},6e4)},stopIfFinishedOnClock:function(){var t,s=this,e=!1,i=0;s.dungeons.forEach(function(n){n.reduceLifeOnClock()&&(e=!0),n.addBonusOnClock(s.time)&&(e=!0),n.updateStatus()&&!n.hasLost&&(e=!0,n.status===D_STATUS_LOST&&broadcast(s,PLAY_EVENT_LOST,s.toJSON()),n.hasLost=!0),n.status===D_STATUS_PLAYING&&(t=n,i++)}),e&&broadcast(s,PLAY_EVENT_UPDATE,s.toJSON()),i<=1&&(t&&(t.status=D_STATUS_WON,broadcast(s,D_STATUS_WON,s.toJSON())),this.stop())},checkClock:function(){this.time++,this.time>MAX_CLOCK_TIME&&this.stop(),this.stopIfFinishedOnClock(),this.startIfReady()},toJSON:function(){return{id:this.id,name:this.name,status:this.status,dungeons:this.dungeons.map(function(t){return t.toJSON?t.toJSON():t}),options:this.options}}},Dungeon.prototype={applyState:function(t,s,e,i){if(this.status!=D_STATUS_PLAYING||i.status!=D_STATUS_PLAYING)return!1;var n=this.area.getState(t,s);if(this.id===i.id){if(!(!(e&STATE_MONEY)||n&STATE_WALL||n&STATE_PLAYER)||!(!(e&STATE_RHUM)||n&STATE_WALL||n&STATE_PLAYER))return this.area.setState(t,s,n&STATE_DYNAMITE|e),!0;if(e&STATE_DYNAMITE&&n&STATE_WALL&&i.money>=this.config.dynamiteCost)return this.area.setState(t,s,STATE_DEFAULT|STATE_BOUM),!0}else{if(e&STATE_WALL&&!(n&(STATE_WALL|STATE_PLAYER))&&i.money>=this.config.wallCost)return this.area.setState(t,s,e),!0;if(e&STATE_DYNAMITE&&!(n&(STATE_WALL|STATE_DYNAMITE|STATE_PLAYER))&&i.money>=this.config.dynamiteCost)return this.area.setState(t,s,n|e),!0}return!1},deduceMoney:function(t){t&STATE_WALL?this.money-=this.config.wallCost:t&STATE_DYNAMITE&&(this.money-=this.config.dynamiteCost)},movePlayer:function(t){if(this.status!=D_STATUS_PLAYING)return!1;var s=this.player.y,e=this.player.x,i=s,n=e;switch(t){case MOVE_UP:i--;break;case MOVE_DOWN:i++;break;case MOVE_LEFT:n--;break;case MOVE_RIGHT:n++;break;default:console.log("Error can't move "+t)}n=n%this.area.columns+1?n%this.area.columns:this.area.columns-1,i=i%this.area.rows+1?i%this.area.rows:this.area.rows-1;var a=this.area.getState(n,i);return!(a&STATE_WALL)&&(this.area.setState(e,s,STATE_DEFAULT),this.area.setState(n,i,STATE_PLAYER),this.player.x=n,this.player.y=i,this.life--,this.lastUpdateTime=0,a&STATE_RHUM&&(this.life+=this.config.rhumBonusValue),a&STATE_MONEY&&(this.money+=this.config.moneyBonusValue),a&STATE_DYNAMITE&&this.applyTrap(e,s,t),!0)},applyTrap:function(t,s,e){var i;switch(e){case MOVE_UP:i=MOVE_DOWN;break;case MOVE_DOWN:i=MOVE_UP;break;case MOVE_LEFT:i=MOVE_RIGHT;break;case MOVE_RIGHT:i=MOVE_LEFT;break;default:console.log("Error can't move "+e)}for(var n=0;n<=this.config.dynamiteFeedback;n++)this.movePlayer(i);this.area.setState(t,s,STATE_BOUM)},createArea:function(t,s){this.area.reset(t,s);var e=Math.floor((t-1)/2),i=Math.floor((s-1)/2);this.player={x:e,y:i},this.area.setState(e,i,STATE_PLAYER)},applyModifier:function(t){return this.config[t]+this.modifiers[t]},reduceLifeOnClock:function(){var t=this.lastUpdateTime++,s=this.config.timeLimit,e=!1;return t>=s&&t%s==0&&(this.life-=this.applyModifier("timeLimitMalus"),this.modifiers.timeLimitMalus++,e=!0),t<s&&(this.modifiers.timeLimitMalus=0),this.life<=0&&(this.status=D_STATUS_LOST,e=!0),e},addBonusOnClock:function(t){var s=!1;if(t%parseInt(this.config.bonusInterval,10)==0){s=!0;var e=bonusMapState[Math.ceil(Math.random()*bonusMapState.length-1)],i=Math.floor(Math.random()*parseInt(this.area.columns,10)),n=Math.floor(Math.random()*parseInt(this.area.rows,10));this.applyState(i,n,e,this)}return s},updateStatus:function(){return this.life<=0&&(this.status=D_STATUS_LOST,!0)},toJSON:function(){return{id:this.id,name:this.name,area:this.area.toJSON(),life:this.life,money:this.money,lastUpdateTime:this.lastUpdateTime,player:this.player,status:this.status,config:this.config.toJSON(),modifiers:this.modifiers}}},Area.prototype={reset:function(t,s){this.columns=t||0,this.rows=s||0,this.states=[];for(var e=0;e<this.rows;e++){this.states.push([]);for(var i=0;i<this.columns;i++)this.states[e].push({state:STATE_DEFAULT})}},getState:function(t,s){return this.states[s][t].state},setState:function(t,s,e){this.states[s][t].state=e},toJSON:function(){return{columns:this.columns,rows:this.rows,states:this.states}}},Config.prototype={fromJSON:function(t){t=t||{},this.dynamiteFeedback=t.dynamiteFeedback||this.dynamiteFeedback||3,this.dynamiteCost=t.dynamiteCost||this.dynamiteCost||15,this.wallCost=t.wallCost||this.wallCost||5,this.timeLimit=t.timeLimit||this.timeLimit||5,this.timeLimitMalus=t.timeLimitMalus||this.timeLimitMalus||1,this.bonusInterval=t.bonusInterval||this.bonusInterval||5,this.rhumBonusValue=t.rhumBonusValue||this.rhumBonusValue||10,this.moneyBonusValue=t.moneyBonusValue||this.moneyBonusValue||15,this.areaColumns=t.areaColumns||this.areaColumns||11,this.areaRows=t.areaRows||this.areaRows||15},toJSON:function(){return{dynamiteFeedback:this.dynamiteFeedback,dynamiteCost:this.dynamiteCost,wallCost:this.wallCost,timeLimit:this.timeLimit,timeLimitMalus:this.timeLimitMalus,bonusInterval:this.bonusInterval,rhumBonusValue:this.rhumBonusValue,moneyBonusValue:this.moneyBonusValue,areaColumns:this.areaColumns,areaRows:this.areaRows}}},module.exports=function(t){var s=new ServerController(t);controllers.push(s),console.log("Connected: "+t.id)};