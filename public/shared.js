"use strict";function remove(e,t){e.splice(e.indexOf(t),1)}function find(e,t){for(var i=0;i<e.length;i++)if(e[i].id===t)return e[i]}function findIndex(e,t){for(var i=0;i<e.length;i++)if(e[i].id===t)return i}function applyStyleOn(e,t){for(var i in t)e.style[i]=t[i]}function applyAttributesOn(e,t){for(var i in t)e.setAttribute(i,t[i])}function createUIElement(e,t,i){var n=document.createElement(e);t=t||{},i=i||{},applyAttributesOn(n,t);for(var a in i)n.addEventListener(a,i[a]);return n}function Game(e,t,i){this.isServer=!!t,this.room=e,this.id=this.room.id,this.dungeons=[],this.dungeonsUI=[],this.clock=!1,this.started=!1,this.time=0,this.timeOffset=0,this.options=i||["Wall","Trap"]}var MAX_CLOCK_TIME=1800;Game.prototype={destroy:function(){this.isServer&&(clearInterval(this.clock),this.started=!1)},start:function(){this.isServer&&!this.started&&(this.started=(new Date).now,this.broadcast("start"),this.clock=setInterval(this.checkClock.bind(this),1e3))},checkClock:function(){var e=this;this.time++,this.time>MAX_CLOCK_TIME&&(clearInterval(this.clock),this.broadcast("game-lost",{message:"Lost - OUT OF TIME"})),this.reduceLifeOnClock(this.time),this.broadcast("update",e.toJSON())},reduceLifeOnClock:function(e){var t=this;this.dungeons.forEach(function(i){i.lastUpdateTime++,console.log(parseInt(i.config.timeLimit),e-t.timeOffset),i.lastUpdateTime>=parseInt(i.config.timeLimit)*Math.max(Math.ceil((e-t.timeOffset)/10),1)&&(console.log("passed"),i.life-=t.applyModifiers("timeLimitMalus",i),i.modifiers.timeLimitMalus++),i.lastUpdateTime<i.config.timeLimit&&(t.timeOffset=e,i.modifiers.timeLimitMalus=0),i.life<=0&&!i.player.lost&&t.isServer&&(t.room.to(i.id).emit("game-lost",{message:"Lost - OUT OF TIME"}),i.play.lost=!0)})},applyModifiers:function(e,t){return t.config[e]+t.modifiers[e]},removeDungeon:function(e){var t=find(this.dungeons,e);if(t)var i=this.dungeons.indexOf(t);i>=0&&this.dungeons.splice(i,1)},addDungeon:function(e){find(this.dungeons,e.id)?console.warn(e.id+"already exist in thsi game"):this.dungeons.push(e)},checkReady:function(){if(!this.started&&this.isServer){for(var e=!1,t=0;t<this.dungeons.length&&!1!==(e=this.dungeons[t].player.ready);t++);e&&this.start()}},updateGame:function(e){this.options=e.options,this.updateDungeons(e.dungeons),this.checkReady()},updateDungeons:function(e){function t(){var a=e[n],s=a?findIndex(i.dungeons,a.id):void 0,o=s>=0?i.dungeons[s]:void 0;if(o&&a&&o.id===a.id)o.area=a.area,o.life=a.life,o.money=a.money,o.player=a.player;else if(!o&&a)i.dungeons.push(a),i.isServer||i.addDungeonUI(a);else if(i.dungeons[n]&&!a&&!find(e,i.dungeons[n].id)){var d=i.dungeons.splice(n,1)[0];i.dungeonsUI.splice(n,1),i.isServer||i.deleteDungeonUI(d.id)}--n<0||t()}var i=this,n=Math.max(Math.max(i.dungeons.length-1,e.length-1),0);t(),i.isServer||i.updateUI()},deleteDungeonUI:function(e){var t=document.getElementById(e);document.getElementsByTagName("main")[0].removeChild(t)},applyOptionEvent:function(e){var t=e.target,i=t.getAttribute("data-dungeon-id"),n=parseInt(t.getAttribute("data-area-x"),10),a=parseInt(t.getAttribute("data-area-y"),10);find(this.dungeons,i);this.broadcast("apply-option",{dungeonId:i,opponentId:this.id,option:" "+this.selectedOption.toLowerCase(),x:n,y:a})},addDungeonUI:function(e){var t=this,i={id:e.id,area:[]},n=createUIElement("div",{class:"area-container",id:e.id}),a=createUIElement("h1",{class:"dungeon-name"}),s=createUIElement("div",{class:"area"}),o=createUIElement("div",{class:"life-container"}),d=createUIElement("div",{class:"life-bar"}),r=createUIElement("p",{class:"life-count"}),c=createUIElement("p",{class:"money-count"}),l=createUIElement("div",{class:"ready","data-dungeon-id":e.id},{click:function(e){var i=e.target.getAttribute("data-dungeon-id");i===t.id&&t.broadcast("ready",i)}});e.area.forEach(function(n,a){var o=[];n.forEach(function(i,n){var d=createUIElement("div",{class:i,"data-area-x":a,"data-area-y":n,"data-dungeon-id":e.id},{click:t.applyOptionEvent.bind(t)});s.appendChild(d),o.push(d)}),i.area.push(o)}),o.appendChild(d),o.appendChild(r),o.appendChild(c),n.appendChild(a),n.appendChild(o),n.appendChild(l),n.appendChild(s),document.getElementsByTagName("main")[0].appendChild(n),i.lifeBar=d,i.lifeCount=r,i.moneyCount=c,i.readyButton=l,this.dungeonsUI.push(i)},updateUI:function(e){var t=this;this.dungeons.forEach(function(e,i){const n=find(t.dungeonsUI,e.id);applyStyleOn(t.dungeonsUI[i].lifeBar,{height:e.life+"%"}),n.lifeCount.innerHTML=e.life,n.moneyCount.innerHTML=e.money;var a=find(t.dungeonsUI,e.id);e.player.ready?a.readyButton.classList.add("btn-ready"):a.readyButton.classList.remove("btn-ready"),e.area.forEach(function(e,t){e.forEach(function(e,i){applyAttributesOn(n.area[t][i],{class:e.state}),applyStyleOn(n.area[t][i],e.style)})})})},broadcast:function(e,t){this.isServer&&this.room.broadcast.to(this.room.id).emit(e,t),this.room.emit(e,t)},toJSON:function(){return{id:this.id,time:this.time,started:this.started,dungeons:this.dungeons.map(function(e){return e.toJSON?e.toJSON():e}),options:this.options}}};