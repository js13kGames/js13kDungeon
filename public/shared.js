"use strict";function remove(e,n){e.splice(e.indexOf(n),1)}function find(e,n){for(var t=0;t<e.length;t++)if(e[t].id===n)return e[t]}function findIndex(e,n){for(var t=0;t<e.length;t++)if(e[t].id===n)return t}function applyStyleOn(e,n){for(var t in n)e.style[t]=n[t]}function applyAttributesOn(e,n){for(var t in n)e.setAttribute(t,n[t])}function createUIElement(e,n,t){var i=document.createElement(e);n=n||{},t=t||{},applyAttributesOn(i,n);for(var a in t)i.addEventListener(a,t[a]);return i}function Game(e,n,t){this.isServer=!!n,this.room=e,this.id=this.room.id,this.dungeons=[],this.dungeonsUI=[],this.options=t||["Wall","Trap"]}Game.prototype={removeDungeon:function(e){var n=find(this.dungeons,e);if(n)var t=this.dungeons.indexOf(n);t>=0&&this.dungeons.splice(t,1)},addDungeon:function(e){find(this.dungeons,e.id)?console.warn(e.id+"already exist in thsi game"):this.dungeons.push(e)},updateGame:function(e){this.options=e.options,this.updateDungeons(e.dungeons)},updateDungeons:function(e){function n(){var a=e[i],o=a?findIndex(t.dungeons,a.id):void 0,d=o>=0?t.dungeons[o]:void 0;if(d&&a&&d.id===a.id)d.area=a.area,d.life=a.life,d.money=a.money,d.player=a.player;else if(!d&&a)t.dungeons.push(a),t.isServer||t.addDungeonUI(a);else if(t.dungeons[i]&&!a&&!find(e,t.dungeons[i].id)){var s=t.dungeons.splice(i,1)[0];t.dungeonsUI.splice(i,1),t.isServer||t.deleteDungeonUI(s.id)}--i<0||n()}var t=this,i=Math.max(Math.max(t.dungeons.length-1,e.length-1),0);n(),t.isServer||t.updateUI()},deleteDungeonUI:function(e){var n=document.getElementById(e);document.getElementsByTagName("main")[0].removeChild(n)},applyOptionEvent:function(e){var n=e.target,t=n.getAttribute("data-dungeon-id"),i=parseInt(n.getAttribute("data-area-x"),10),a=parseInt(n.getAttribute("data-area-y"),10);find(this.dungeons,t);this.broadcast("apply-option",{dungeonId:t,option:" "+this.selectedOption.toLowerCase(),x:i,y:a})},addDungeonUI:function(e){var n=this,t={id:e.id,area:[]},i=createUIElement("div",{class:"area-container",id:e.id}),a=createUIElement("h1",{class:"dungeon-name"}),o=createUIElement("div",{class:"area"}),d=createUIElement("div",{class:"life-container"}),s=createUIElement("div",{class:"life-bar"}),r=createUIElement("p",{class:"life-count"}),u=createUIElement("p",{class:"money-count"});e.area.forEach(function(i,a){var d=[];i.forEach(function(t,i){var s=createUIElement("div",{class:t,"data-area-x":a,"data-area-y":i,"data-dungeon-id":e.id},{click:n.applyOptionEvent.bind(n)});o.appendChild(s),d.push(s)}),t.area.push(d)}),d.appendChild(s),d.appendChild(r),d.appendChild(u),i.appendChild(a),i.appendChild(d),i.appendChild(o),document.getElementsByTagName("main")[0].appendChild(i),t.lifeBar=s,t.lifeCount=r,t.moneyCount=u,this.dungeonsUI.push(t)},updateUI:function(e){var n=this;this.dungeons.forEach(function(e,t){const i=find(n.dungeonsUI,e.id);applyStyleOn(n.dungeonsUI[t].lifeBar,{height:e.life+"%"}),i.lifeCount.innerHTML=e.life,i.lifeCount.innerHTML=e.life,e.area.forEach(function(e,n){e.forEach(function(e,t){applyAttributesOn(i.area[n][t],{class:e.state}),applyStyleOn(i.area[n][t],e.style)})})})},broadcast:function(e,n){this.isServer&&this.room.broadcast.to(this.room.id).emit(e,n),this.room.emit(e,n)},toJSON:function(){return{id:this.id,dungeons:this.dungeons.map(function(e){return e.toJSON?e.toJSON():e}),options:this.options}}};